#!/usr/bin/env python3
import os, sys, time, readline, subprocess

def run_repl():
    os.system('clear')
    print("\033[1;32m┌──────────────────────────────────────────────────┐")
    print(f"│ GEMINI OS | NODE: gnode-server | HYBRID UI v4.3  │")
    print("└──────────────────────────────────────────────────┘\033[0m")
    print("\033[3;37m(Syötä komentoja, koodia tai puhu vapaasti)\033[0m\n")
    
    context = {}
    while True:
        try:
            line = input("\033[1;34mλ > \033[0m").strip()
            if not line: continue
            if line.lower() in ['exit', 'quit']: break
            
            # 1. TUNNETUT KOMENNOT (Quick Aliases)
            if line == 'status':
                os.system('uptime -p && df -h / | tail -1')
                continue

            # 2. YRITÄ PYTHONIA (Koodi/Laskenta)
            try:
                # Jos on validia Pythonia, suoritetaan se
                compile(line, '<string>', 'single')
                try:
                    result = eval(line, globals(), context)
                    if result is not None:
                        print(f"\033[1;33m=> {result}\033[0m")
                except:
                    exec(line, globals(), context)
                print(f"\033[1;32m[CODE OK - {time.strftime('%H:%M:%S')}]\033[0m")
                continue
            except (SyntaxError, NameError):
                # 3. FALLBACK AI:LLE (Vapaa teksti)
                # Jos ei ollut koodia, lähetetään se AI-skriptille
                print("\033[1;36m(Gemini 2.5 analysoi...)\033[0m")
                # Ohjataan syöte ai-skriptille, joka käyttää 2.5-mallia
                subprocess.run(['/home/ubuntu/bin/ai', line])
                print(f"\n\033[1;32m[AI OK - {time.strftime('%H:%M:%S')}]\033[0m")

        except KeyboardInterrupt:
            print("\nKäytä 'exit' lopettaaksesi.")
            continue
        except EOFError:
            break
        except Exception as e:
            print(f"\033[1;31m!!! JÄRJESTELMÄVIRHE: {e} !!!\033[0m")

if __name__ == "__main__":
    run_repl()
