#!/bin/bash
# Gemini OS - TXTAR (Vakaa: [tag: tiedosto])

if [ -t 0 ] && [ "$#" -eq 0 ]; then
    echo "Sy√∂t√§ koodi (esim. [run: skripti.py]) ja paina CTRL+d:"
fi

python3 -c "
import sys, os, subprocess, stat

data = sys.stdin.read().split('-- ')
for section in data:
    if ' --' in section:
        header, content = section.split(' --', 1)
        header = header.strip()
        
        tag = None
        filename = header
        
        # Tunnistetaan [tag: tiedosto]
        if header.startswith('[') and ':' in header:
            try:
                tag_part = header[1:header.find(']')]
                tag, filename = [x.strip() for x in tag_part.split(':', 1)]
            except:
                pass

        if not filename: continue

        # Luodaan tiedosto
        os.makedirs(os.path.dirname(filename) or '.', exist_ok=True)
        with open(filename, 'w') as f:
            f.write(content.lstrip())
        
        print(f'‚ûú Tallennettu: {filename}')

        # K√§sitell√§√§n tagit
        if tag == 'run':
            # Asetetaan suoritusoikeudet (chmod +x)
            st = os.stat(filename)
            os.chmod(filename, st.st_mode | stat.S_IEXEC)
            
            print(f'üöÄ Suoritetaan [run]: {filename}')
            try:
                # Suoritetaan tiedostotyypin mukaan
                if filename.endswith('.py'):
                    subprocess.run([sys.executable, filename], check=True)
                else:
                    # K√§ytet√§√§n t√§ytt√§ polkua suoritukseen
                    full_path = os.path.abspath(filename)
                    subprocess.run([full_path], check=True)
            except Exception as e:
                print(f'‚ùå Virhe suorituksessa: {e}')
        
        elif tag in ['security', 'ACL', 'gpg']:
            os.chmod(filename, 0o600)
            print(f'üîí Suojattu [{tag}]: {filename}')
"
